name: ETL nightly

on:
  schedule:
    - cron: "0 18 * * *"     # 01:00 GMT+7 (18:00 UTC ngày trước)
  workflow_dispatch: {}       # cho phép bấm chạy tay

permissions:
  contents: write             # cần quyền push

jobs:
  run-etl:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          pip install -r requirements.txt

      # (Tùy) Nếu bạn vẫn giữ code ingest từ ZIP => comment nếu không dùng
      # - name: Ingest bronze from ZIP (optional)
      #   run: |
      #     python lake/ingest_from_zip.py

      - name: Run ETL (silver → gold → kol)
        run: |
          python lake/transform_to_silver.py
          python lake/build_gold.py
          python lake/kol_build.py

      - name: Prepare data branch content
        run: |
          mkdir -p publish/daily_metrics publish/kol_performance
          cp -f data/lake/gold/daily_metrics/full.parquet publish/daily_metrics/full.parquet
          cp -f data/lake/gold/kol_performance/full.parquet publish/kol_performance/full.parquet

            - name: Push artifacts to data branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          git config user.name  "github-actions"
          git config user.email "actions@users.noreply.github.com"

          # 1) Lấy branch data (nếu có trên remote) về local với ref đầy đủ
          if git ls-remote --exit-code --heads origin data >/dev/null 2>&1; then
            git fetch origin refs/heads/data:refs/heads/data
            git checkout refs/heads/data
          else
            # Chưa có → tạo orphan branch 'data' (không có lịch sử)
            git checkout --orphan data
          fi

          # 2) Xoá mọi thứ ở branch data hiện tại, CHỈ giữ thư mục publish/
          # (Ở branch main, thư mục 'data/' sẽ không bị ảnh hưởng vì ta đang ở branch data)
          find . -maxdepth 1 \
            -not -name '.' \
            -not -name '.git' \
            -not -name 'publish' \
            -exec rm -rf {} +

          # 3) Di chuyển nội dung publish/* ra root (nếu có)
          if [ -d publish ]; then
            shopt -s nullglob dotglob
            mv publish/* . 2>/dev/null || true
            rm -rf publish
          fi

          # 4) Commit & force-push lên remote/branch data
          git add -A
          git commit -m "nightly gold update $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "no changes"
          git push origin HEAD:refs/heads/data --force
